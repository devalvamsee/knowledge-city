name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout the repo
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Set up Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'   # Change if needed

    # 3Ô∏è‚É£ Check environment
    - name: Check environment
      run: |
        echo "üîç Checking Node and NPM..."
        node -v
        npm -v

    # 4Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        if [ ! -f package.json ]; then
          echo "‚ö†Ô∏è No package.json found, creating a minimal one..."
          cat > package.json <<EOF
          {
            "name": "node-js",
            "version": "1.0.0",
            "main": "app.js",
            "scripts": { "start": "node app.js" },
            "dependencies": { "express": "^4.18.2" }
          }
EOF
        fi
        npm install

    # 5Ô∏è‚É£ Build step (optional)
    - name: Build project
      run: |
        echo "üèóÔ∏è Build step complete."

    # 6Ô∏è‚É£ Run tests
    - name: Run tests
      run: |
        echo "üß™ Running tests..."
        if npm run | grep -q "test"; then
          npm test
        else
          echo "‚ö†Ô∏è No tests defined in package.json"
        fi

    # 7Ô∏è‚É£ Start Node app (local test)
    - name: Start Node.js app
      run: |
        echo "üöÄ Starting Node.js app..."
        nohup node app.js > app.log 2>&1 &
        sleep 5

    # 8Ô∏è‚É£ Verify app is running
    - name: Verify deployment
      run: |
        echo "üîé Verifying Node.js app..."
        if pgrep -f "node app.js" > /dev/null; then
          echo "‚úÖ Node.js app is running."
          curl -s http://localhost:3000 || echo "‚ö†Ô∏è App did not respond properly."
        else
          echo "‚ùå Node.js app failed to start."
          echo "---- app.log ----"
          cat app.log
          echo "-----------------"
          exit 1
        fi

    # 9Ô∏è‚É£ Cleanup (optional)
    - name: Stop Node.js app
      if: always()
      run: |
        echo "üõë Stopping Node.js app..."
        pkill -f "node app.js" || true

